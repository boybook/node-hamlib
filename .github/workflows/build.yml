name: Build Precompiled Binaries

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  # Â§öÂπ≥Âè∞Âπ∂Ë°åÊûÑÂª∫
  build:
    env:
      HAMLIB_VERSION: '4.6.5'
      PTHREADS_SOURCEWARE_DIR: 'prebuilt-dll-2-9-1-release'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            target: linux-x64
            hamlib_install: |
              sudo apt-get update
              sudo apt-get install -y libhamlib-dev libhamlib-utils patchelf
              # Install runtime dependencies for bundling
              sudo apt-get install -y libusb-1.0-0 libindi1 || true
          - os: ubuntu-24.04-arm
            arch: arm64
            target: linux-arm64
            hamlib_install: |
              sudo apt-get update
              sudo apt-get install -y libhamlib-dev libhamlib-utils patchelf
              # Install runtime dependencies for bundling
              sudo apt-get install -y libusb-1.0-0 libindi1 || true
          - os: windows-latest
            arch: x64
            target: win32-x64
            hamlib_install: |
              echo "Setting up Windows hamlib from repository folder or official zip"
              $ErrorActionPreference = 'Stop'
              $ver = $env:HAMLIB_VERSION
              $localFolder = Join-Path $env:GITHUB_WORKSPACE "hamlib-w64-$ver"
              if ((Test-Path $localFolder -PathType Container) -and (Test-Path (Join-Path $localFolder 'bin'))) {
                Write-Host "Found local hamlib folder: $localFolder"
                $root = $localFolder
              } else {
                $zipUrl = "https://github.com/Hamlib/Hamlib/releases/download/$ver/hamlib-w64-$ver.zip"
                $zipPath = Join-Path $env:RUNNER_TEMP "hamlib-w64-$ver.zip"
                Write-Host "Downloading $zipUrl"
                Invoke-WebRequest -Uri $zipUrl -OutFile $zipPath
                $dest = Join-Path $env:GITHUB_WORKSPACE 'hamlib'
                if (Test-Path $dest) { Remove-Item -Recurse -Force $dest }
                New-Item -ItemType Directory -Path $dest | Out-Null
                Add-Type -AssemblyName System.IO.Compression.FileSystem
                [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $dest)
                # Detect nested folder in zip (e.g., hamlib-w64-<ver>)
                $root = $dest
                if (!(Test-Path (Join-Path $root 'bin'))) {
                  $child = Get-ChildItem -Path $dest -Directory | Select-Object -First 1
                  if ($null -ne $child -and (Test-Path (Join-Path $child.FullName 'bin'))) {
                    $root = $child.FullName
                  }
                }
              }
              Write-Host "HAMLIB root detected at: $root"
              "HAMLIB_ROOT=$root" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
              (Join-Path $root 'bin') | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          - os: macos-latest
            arch: arm64
            target: darwin-arm64
            hamlib_install: |
              brew install hamlib
              pip3 install setuptools --break-system-packages || true

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Prepare pthreads from Sourceware (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $dir = $env:PTHREADS_SOURCEWARE_DIR
        $base = "https://sourceware.org/pub/pthreads-win32/$dir"
        $root = Join-Path $env:RUNNER_TEMP 'pthreads-root'
        if (Test-Path $root) { Remove-Item -Recurse -Force $root }
        New-Item -ItemType Directory -Path (Join-Path $root 'lib/x64') -Force | Out-Null
        foreach ($f in @('pthread.h','sched.h','semaphore.h')) {
          $url = "$base/include/$f"
          $dst = Join-Path $root $f
          Write-Host "Downloading $url -> $dst"
          Invoke-WebRequest -Uri $url -OutFile $dst
        }
        $libUrl = "$base/lib/x64/pthreadVC2.lib"
        $libDst = Join-Path $root 'lib/x64/pthreadVC2.lib'
        Write-Host "Downloading $libUrl -> $libDst"
        Invoke-WebRequest -Uri $libUrl -OutFile $libDst
        "PTHREAD_ROOT=$root" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Hamlib dependencies
      run: ${{ matrix.hamlib_install }}

    - name: Install Node.js dependencies (skip scripts)
      run: npm ci --ignore-scripts

    - name: Ensure node-gyp path (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        $ng = Join-Path $env:GITHUB_WORKSPACE 'scripts\node-gyp-win.cmd'
        if (!(Test-Path $ng)) { throw "node-gyp not found in node_modules/.bin" }
        Write-Host "Using node-gyp at: $ng"
        "PREBUILD_NODE_GYP=$ng" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "PREBUILD_PLATFORM=win32" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        "PREBUILD_ARCH=x64" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
        # PREBUILD_SHELL is not used by prebuildify's build phase; our wrapper handles Windows spawning

    - name: Setup Developer Command Prompt (Windows)
      if: matrix.os == 'windows-latest'
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    - name: Generate prebuilds and bundle hamlib (Windows)
      if: matrix.os == 'windows-latest'
      run: |
        node scripts/run-prebuildify.js
        node scripts/bundle-hamlib.js

    - name: Generate prebuilds and bundle hamlib (Non-Windows)
      if: matrix.os != 'windows-latest'
      run: npm run prebuild:bundle

    - name: List generated prebuilds
      shell: bash
      run: |
        echo "Generated prebuilds:"
        find prebuilds -maxdepth 2 -type f \( -name "*.node" -o -name "*.so*" -o -name "*.dylib" -o -name "*.dll" \) -print || true

    - name: Verify dependencies (All platforms)
      run: node scripts/verify-dependencies.js

    - name: Verify Linux RUNPATH (Linux only - detailed check)
      if: startsWith(matrix.os, 'ubuntu')
      run: node scripts/verify-linux-rpath.js

    # ‰∏ä‰º†ÊØè‰∏™Âπ≥Âè∞ÁöÑÈ¢ÑÁºñËØë‰∫ßÁâ©
    - name: Upload platform prebuilds artifact
      uses: actions/upload-artifact@v4
      with:
        name: prebuilds-${{ matrix.target }}
        path: prebuilds/**
        retention-days: 1  # Âè™‰øùÁïô1Â§©ÔºåÂõ†‰∏∫ÊúÄÁªà‰ºöÂêàÂπ∂

  # Êî∂ÈõÜÊâÄÊúâÂπ≥Âè∞ÊûÑÂª∫‰∫ßÁâ©Âπ∂Áªü‰∏ÄÊâìÂåÖ
  package:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Prepare prebuilds directory
      run: |
        mkdir -p prebuilds
        echo "Prepared prebuilds directory for collecting platform prebuilds"

    # ‰∏ãËΩΩÊâÄÊúâÂπ≥Âè∞ÁöÑÊûÑÂª∫‰∫ßÁâ©
    - name: Download linux-x64 prebuilds
      uses: actions/download-artifact@v4
      with:
        name: prebuilds-linux-x64
        path: prebuilds

    - name: Download linux-arm64 prebuilds
      uses: actions/download-artifact@v4
      with:
        name: prebuilds-linux-arm64
        path: prebuilds

    - name: Download darwin-arm64 prebuilds
      uses: actions/download-artifact@v4
      with:
        name: prebuilds-darwin-arm64
        path: prebuilds

    - name: Flatten prebuilds directory
      shell: bash
      run: |
        if [ -d prebuilds/prebuilds ]; then
          echo "Flattening nested prebuilds directory..."
          shopt -s dotglob nullglob || true
          mv prebuilds/prebuilds/* prebuilds/ || true
          rm -rf prebuilds/prebuilds || true
        fi

    - name: Debug list prebuilds
      run: |
        echo "Listing prebuilds content before verify:"
        find prebuilds -maxdepth 4 -type f -print | sort || true

    - name: Download win32-x64 prebuilds
      uses: actions/download-artifact@v4
      with:
        name: prebuilds-win32-x64
        path: prebuilds

    - name: Verify collected prebuilds
      run: node .github/scripts/verify-build.js

    - name: Create unified prebuilds package
      run: |
        # ÂàõÂª∫ÁâàÊú¨‰ø°ÊÅØÊñá‰ª∂
        cat > prebuilds/BUILD_INFO.txt << EOF
        Node-HamLib Precompiled Binaries
        ================================
        Build Time: $(date -u)
        Git Commit: ${{ github.sha }}
        Git Ref: ${{ github.ref }}
        
        Supported Platforms:
        EOF
        
        # Ê∑ªÂä†Âπ≥Âè∞‰ø°ÊÅØ
        for dir in prebuilds/*/; do
          if [ -d "$dir" ] && [ "$(basename "$dir")" != "BUILD_INFO.txt" ]; then
            platform=$(basename "$dir")
            echo "- $platform" >> prebuilds/BUILD_INFO.txt
          fi
        done
        
        echo "" >> prebuilds/BUILD_INFO.txt
        echo "Installation: Extract to your project's prebuilds/ directory" >> prebuilds/BUILD_INFO.txt
        
        # ÂàõÂª∫Áªü‰∏ÄÁöÑzipÂåÖ
        cd prebuilds
        zip -r ../node-hamlib-prebuilds.zip . -x "*.DS_Store" "*/.*"
        cd ..
        
        echo "üì¶ Created unified package: node-hamlib-prebuilds.zip"
        ls -la node-hamlib-prebuilds.zip

    - name: Generate package summary
      id: package_info
      run: |
        PACKAGE_SIZE=$(ls -la node-hamlib-prebuilds.zip | awk '{print $5}')
        PLATFORM_COUNT=$(find prebuilds -name "*.node" | wc -l)
        
        echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
        echo "platform_count=$PLATFORM_COUNT" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u)" >> $GITHUB_OUTPUT

    # ‰∏ä‰º†ÊúÄÁªàÁöÑÁªü‰∏ÄÂåÖ
    - name: Upload unified prebuilds package
      uses: actions/upload-artifact@v4
      with:
        name: node-hamlib-prebuilds
        path: node-hamlib-prebuilds.zip
        retention-days: 90

    # Â¶ÇÊûúÊòØÊ†áÁ≠æÊé®ÈÄÅÔºåÂàõÂª∫GitHub Release
    - name: Create GitHub Release (on tags)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: "Node-HamLib ${{ github.ref_name }}"
        draft: false
        prerelease: false
        artifacts: node-hamlib-prebuilds.zip
        body: |
          # Node-HamLib ${{ github.ref_name }}
          
          ## üì¶ Precompiled Binaries Package
          
          This release includes precompiled binaries for multiple platforms:
          
          **Platforms included:** 4 platforms (Linux x64/ARM64, macOS ARM64, Windows x64)  
          **Package size:** ${{ steps.package_info.outputs.package_size }} bytes  
          **Build date:** ${{ steps.package_info.outputs.build_date }}
          
          ### Installation
          
          1. Download `node-hamlib-prebuilds.zip`
          2. Extract to your project's `prebuilds/` directory
          3. The binaries will be automatically detected and used
          
          ### Supported Platforms
          
          - ‚úÖ Linux x64
          - ‚úÖ Linux ARM64  
          - ‚úÖ macOS ARM64 (Apple Silicon)
          - ‚úÖ Windows x64
          
          ### Usage
          
          ```bash
          npm install node-hamlib
          ```
          
          The precompiled binaries will be automatically used if available for your platform, otherwise it will fall back to building from source.

  # Ê∏ÖÁêÜ‰∏¥Êó∂artifactsÔºàÂèØÈÄâÔºâ
  cleanup:
    needs: [build, package]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Delete temporary platform artifacts
      uses: geekyeggo/delete-artifact@v5
      with:
        name: |
          prebuilds-linux-x64
          prebuilds-linux-arm64
          prebuilds-darwin-arm64
          prebuilds-win32-x64
        failOnError: false
