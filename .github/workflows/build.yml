name: Build Precompiled Binaries

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  # å¤šå¹³å°å¹¶è¡Œæ„å»º
  build:
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
            target: linux-x64
            hamlib_install: |
              sudo apt-get update
              sudo apt-get install -y libhamlib-dev libhamlib-utils
          - os: ubuntu-latest  # ä½¿ç”¨Ubuntuæ¨¡æ‹ŸARM64æ„å»ºï¼ˆå®é™…é¡¹ç›®å¯èƒ½éœ€è¦çœŸå®çš„ARM runnerï¼‰
            arch: arm64
            target: linux-arm64
            hamlib_install: |
              sudo apt-get update
              sudo apt-get install -y libhamlib-dev libhamlib-utils
          # - os: windows-latest
          #   arch: x64
          #   target: win32-x64
          #   hamlib_install: |
          #     echo "Setting up Windows build environment"
          #     # Windows ç¯å¢ƒä¸‹é€šè¿‡ vcpkg æˆ–å…¶ä»–æ–¹å¼å®‰è£… hamlib
          #     # æš‚æ—¶è·³è¿‡ hamlib å®‰è£…ï¼Œä¾èµ–é¡¹ç›®å†…ç½®çš„ hamlib æ„å»ºé€»è¾‘
          - os: macos-latest
            arch: arm64
            target: darwin-arm64
            hamlib_install: |
              brew install hamlib
              pip3 install setuptools --break-system-packages || true

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Install Hamlib dependencies
      run: ${{ matrix.hamlib_install }}

    - name: Install Node.js dependencies
      run: npm ci

    - name: Build node-hamlib
      run: npm run build

    - name: Verify build output
      shell: bash
      run: |
        if [ -f "build/Release/hamlib.node" ]; then
          echo "âœ… Build successful: hamlib.node found"
          file build/Release/hamlib.node || true
          ls -la build/Release/hamlib.node
        else
          echo "âŒ Error: hamlib.node not found"
          ls -la build/Release/ || true
          exit 1
        fi

    - name: Create platform binary
      shell: bash
      run: |
        mkdir -p dist/${{ matrix.target }}
        cp build/Release/hamlib.node dist/${{ matrix.target }}/
        echo "Binary created for ${{ matrix.target }}"

    # ä¸Šä¼ æ¯ä¸ªå¹³å°çš„æ„å»ºäº§ç‰©ä¸ºç‹¬ç«‹çš„artifact
    - name: Upload platform artifact
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.target }}
        path: dist/${{ matrix.target }}/
        retention-days: 1  # åªä¿ç•™1å¤©ï¼Œå› ä¸ºæœ€ç»ˆä¼šåˆå¹¶

  # æ”¶é›†æ‰€æœ‰å¹³å°æ„å»ºäº§ç‰©å¹¶ç»Ÿä¸€æ‰“åŒ…
  package:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Create prebuilds directory structure
      run: |
        mkdir -p prebuilds
        echo "Created prebuilds directory for collecting all platform binaries"

    # ä¸‹è½½æ‰€æœ‰å¹³å°çš„æ„å»ºäº§ç‰©
    - name: Download linux-x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: binary-linux-x64
        path: prebuilds/linux-x64/

    - name: Download linux-arm64 artifact
      uses: actions/download-artifact@v4
      with:
        name: binary-linux-arm64
        path: prebuilds/linux-arm64/

    - name: Download darwin-arm64 artifact
      uses: actions/download-artifact@v4
      with:
        name: binary-darwin-arm64
        path: prebuilds/darwin-arm64/

    # - name: Download win32-x64 artifact
    #   uses: actions/download-artifact@v4
    #   with:
    #     name: binary-win32-x64
    #     path: prebuilds/win32-x64/

    - name: Verify collected binaries
      run: |
        echo "ğŸ“‹ Collected prebuilds structure:"
        find prebuilds -type f -name "*.node" | sort
        echo ""
        echo "ğŸ“Š Binary details:"
        for binary in $(find prebuilds -name "*.node"); do
          echo "ğŸ”¹ $binary"
          ls -la "$binary"
          file "$binary" || true
          echo ""
        done

    - name: Create unified prebuilds package
      run: |
        # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
        cat > prebuilds/BUILD_INFO.txt << EOF
        Node-HamLib Precompiled Binaries
        ================================
        Build Time: $(date -u)
        Git Commit: ${{ github.sha }}
        Git Ref: ${{ github.ref }}
        
        Supported Platforms:
        EOF
        
        # æ·»åŠ å¹³å°ä¿¡æ¯
        for dir in prebuilds/*/; do
          if [ -d "$dir" ] && [ "$(basename "$dir")" != "BUILD_INFO.txt" ]; then
            platform=$(basename "$dir")
            echo "- $platform" >> prebuilds/BUILD_INFO.txt
          fi
        done
        
        echo "" >> prebuilds/BUILD_INFO.txt
        echo "Installation: Extract to your project's prebuilds/ directory" >> prebuilds/BUILD_INFO.txt
        
        # éªŒè¯æ„å»ºäº§ç‰©
        echo "ğŸ” Verifying build artifacts..."
        EXPECTED_PLATFORMS=("linux-x64" "linux-arm64" "darwin-arm64")
        FOUND_PLATFORMS=0
        
        for platform in "${EXPECTED_PLATFORMS[@]}"; do
          if [ -f "prebuilds/$platform/hamlib.node" ]; then
            echo "âœ… Found binary for $platform"
            FOUND_PLATFORMS=$((FOUND_PLATFORMS + 1))
          else
            echo "âŒ Missing binary for $platform"
          fi
        done
        
        if [ $FOUND_PLATFORMS -eq ${#EXPECTED_PLATFORMS[@]} ]; then
          echo "ğŸ‰ All $FOUND_PLATFORMS platform binaries verified successfully"
        else
          echo "âŒ Build verification failed: $FOUND_PLATFORMS/${#EXPECTED_PLATFORMS[@]} platforms found"
          exit 1
        fi
        
        # åˆ›å»ºç»Ÿä¸€çš„zipåŒ…
        cd prebuilds
        zip -r ../node-hamlib-prebuilds.zip . -x "*.DS_Store" "*/.*"
        cd ..
        
        echo "ğŸ“¦ Created unified package: node-hamlib-prebuilds.zip"
        ls -la node-hamlib-prebuilds.zip

    - name: Generate package summary
      id: package_info
      run: |
        PACKAGE_SIZE=$(ls -la node-hamlib-prebuilds.zip | awk '{print $5}')
        PLATFORM_COUNT=$(find prebuilds -name "*.node" | wc -l)
        
        echo "package_size=$PACKAGE_SIZE" >> $GITHUB_OUTPUT
        echo "platform_count=$PLATFORM_COUNT" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u)" >> $GITHUB_OUTPUT

    # ä¸Šä¼ æœ€ç»ˆçš„ç»Ÿä¸€åŒ…
    - name: Upload unified prebuilds package
      uses: actions/upload-artifact@v4
      with:
        name: node-hamlib-prebuilds
        path: node-hamlib-prebuilds.zip
        retention-days: 90

    # å¦‚æœæ˜¯æ ‡ç­¾æ¨é€ï¼Œåˆ›å»ºGitHub Release
    - name: Create GitHub Release (on tags)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ github.ref_name }}
        name: "Node-HamLib ${{ github.ref_name }}"
        draft: false
        prerelease: false
        artifacts: node-hamlib-prebuilds.zip
        body: |
          # Node-HamLib ${{ github.ref_name }}
          
          ## ğŸ“¦ Precompiled Binaries Package
          
          This release includes precompiled binaries for multiple platforms:
          
          **Platforms included:** 3 platforms (Linux x64/ARM64, macOS ARM64)  
          **Package size:** ${{ steps.package_info.outputs.package_size }} bytes  
          **Build date:** ${{ steps.package_info.outputs.build_date }}
          
          ### Installation
          
          1. Download `node-hamlib-prebuilds.zip`
          2. Extract to your project's `prebuilds/` directory
          3. The binaries will be automatically detected and used
          
          ### Supported Platforms
          
          - âœ… Linux x64
          - âœ… Linux ARM64  
          - âœ… macOS ARM64 (Apple Silicon)
          <!-- - âœ… Windows x64 -->
          
          ### Usage
          
          ```bash
          npm install node-hamlib
          ```
          
          The precompiled binaries will be automatically used if available for your platform, otherwise it will fall back to building from source.

  # æ¸…ç†ä¸´æ—¶artifactsï¼ˆå¯é€‰ï¼‰
  cleanup:
    needs: [build, package]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Delete temporary platform artifacts
      uses: geekyeggo/delete-artifact@v5
      with:
        name: |
          binary-linux-x64
          binary-linux-arm64
          binary-darwin-arm64
        failOnError: false


